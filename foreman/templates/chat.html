{% extends '_base.html' %}
{% block title %}Foreman{% endblock %}

{% block content %}

<div class="assistant">
    <div class="ai-assistant-card">
        <h2><box-icon name='brain' size="50px" color="#3498db"></box-icon> AI Assistant</h2>
        <div class="chat-container">
            <div id="chat-messages" class="chat-messages">
                <div class="message system-message">
                    Hello! I'm Foreman, your AI assistant. Ask me about materials, asset locations, or procurement status.
                </div>
                <!-- Messages will be appended here -->
            </div>
            
            <form id="ai-form">
                {% csrf_token %}
                <div class="chat-input">
                    <input type="text" name="query" id="query" placeholder="Ask me anything..." required>
                    <button type="submit"><box-icon name='send' color="#3498db" size="40px"></box-icon></button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('ai-form').addEventListener('submit', function(e) {
    e.preventDefault(); 
    
    const query = document.getElementById('query').value;
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    
    // Show user message
    const chatMessages = document.getElementById('chat-messages');
    const userMessage = document.createElement('div');
    userMessage.className = 'message user-message';
    userMessage.textContent = query;
    chatMessages.appendChild(userMessage);
    
    // Clear the input
    document.getElementById('query').value = '';
    
    // Add loading message
    const loadingMessage = document.createElement('div');
    loadingMessage.className = 'message system-message';
    loadingMessage.textContent = 'Thinking...';
    chatMessages.appendChild(loadingMessage);
    
    // Send AJAX request
    fetch('{% url "ai_assistant" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            query: query
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading message
        chatMessages.removeChild(loadingMessage);
        
        // Add AI response
        const aiResponse = document.createElement('div');
        aiResponse.className = 'message system-message';
        aiResponse.textContent = data.response;
        chatMessages.appendChild(aiResponse);
        
        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => {
        // Remove loading message
        chatMessages.removeChild(loadingMessage);
        
        // Add error message
        const errorMessage = document.createElement('div');
        errorMessage.className = 'message system-message error';
        errorMessage.textContent = 'Sorry, something went wrong. Please try again.';
        chatMessages.appendChild(errorMessage);
        
        console.error('Error:', error);
    });
});
</script>

{% endblock %}